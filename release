#!/bin/bash

set -euo pipefail

script_dir="$(dirname "${BASH_SOURCE[0]}")"
root="$(realpath "$script_dir")"

packages=("client" "core" "notes" "server" "storage" "tasks")

sub="${1:-help}"

case "$sub" in
	"list" | "ls")
		{ for pkg in "${packages[@]}"; do
			echo "$pkg" $(jq ".version" "$root/$pkg/package.json" | tr -d '\"')
		done
		} | column -t
		;;
	"tag-releases")
		for pkg in "${packages[@]}"; do
			v="$(jq -r ".version" "$root/$pkg/package.json")"
			tag="$pkg@$v"
			if git -C "$root" rev-parse "$tag" >/dev/null 2>&1; then
				echo "$tag: already exists, skipping"
			else
				git -C "$root" tag "$tag" -m "$tag"
				echo "Created tag $tag"
			fi
		done
		;;
	"diff")
		pkg="${2:?Package name required}"
		if [ -n "${3:-}" ]; then
			tag="$pkg@$3"
		else
			tag="$(git tag --list "$pkg@*" --sort=-v:refname | head -n 1)"
		fi
		if [ -z "$tag" ]; then
			echo "No tags found for '$pkg'"
			exit 1
		fi
		git diff "$tag..main" -- "$pkg"
		;;
	"history")
		pkg="${2:?Package name required}"
		git tag --list "$pkg@*" | sed "s/^$pkg@//" | sort -V
		;;
	"help" | *)
		cat << EOF
Usage: $0 <command>

Commands:
    list, ls               List current versions in package.json files
    tag-releases           Create git tags for current versions if they don't exist
    diff <pkg> [version]   Show diff between the the specified or last tagged version and main for the given package
    history <pkg>          List releases for the given package
    help                   Show this help message
EOF
		if [ "$sub" != "help" ]; then
			exit 1
		fi
		;;
esac 