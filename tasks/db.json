{
	"$schema": "../server/schemas/db.json",
	"format": 1,
	"versions": [
		{
			"delta": false,
			"tables": {
				"task_lists": {
					"columns": {
						"id": { "type": "uuid", "required": true, "primary": true, "default": "gen_random_uuid()" },
						"userId": { "type": "uuid", "required": true, "references": "users.id", "onDelete": "cascade" },
						"created": { "type": "timestamptz", "required": true, "default": "now()" },
						"publicPermission": { "type": "integer", "required": true, "default": 0 },
						"name": { "type": "text", "required": true },
						"description": { "type": "text" }
					}
				},
				"tasks": {
					"columns": {
						"id": { "type": "uuid", "required": true, "primary": true, "default": "gen_random_uuid()" },
						"created": { "type": "timestamptz", "required": true, "default": "now()" },
						"listId": { "type": "uuid", "required": true, "references": "task_lists.id", "onDelete": "cascade" },
						"summary": { "type": "text", "required": true },
						"description": { "type": "text" },
						"parentId": { "type": "uuid", "references": "tasks.id", "onDelete": "cascade" },
						"completed": { "type": "boolean", "required": true, "default": false },
						"due": { "type": "timestamptz" }
					}
				},
				"acl.task_lists": {
					"columns": {
						"userId": { "type": "uuid", "required": true, "references": "users.id", "onDelete": "cascade" },
						"itemId": { "type": "uuid", "required": true, "references": "task_lists.id", "onDelete": "cascade" },
						"createdAt": { "type": "timestamptz", "required": true, "default": "now()" },
						"permission": { "type": "integer", "required": true, "check": "permission >= 0 AND permission <= 5" }
					},
					"constraints": {
						"PK_acl_task_lists": { "type": "primary_key", "on": ["userId", "itemId"] }
					}
				}
			},
			"indexes": {
				"task_lists_userId": { "on": "task_lists", "columns": ["userId"] },
				"acl_task_lists_userId": { "on": "acl.task_lists", "columns": ["userId"] },
				"acl_task_lists_itemId": { "on": "acl.task_lists", "columns": ["itemId"] },
				"tasks_listId": { "on": "tasks", "columns": ["listId"] },
				"tasks_parentId": { "on": "tasks", "columns": ["parentId"] }
			}
		},
		{
			"delta": true,
			"alter_tables": {
				"task_lists": {
					"drop_columns": ["publicPermission"]
				},
				"acl.task_lists": {
					"drop_constraints": ["PK_acl_task_lists"],
					"drop_columns": ["permission"],
					"add_columns": {
						"role": { "type": "text" },
						"tag": { "type": "text" },
						"read": { "type": "boolean", "required": true, "default": false },
						"edit": { "type": "boolean", "required": true, "default": false },
						"manage": { "type": "boolean", "required": true, "default": false }
					},
					"alter_columns": {
						"userId": { "ops": ["drop_required"] }
					},
					"add_constraints": {
						"unique_task_lists": { "type": "unique", "on": ["itemId", "userId", "role", "tag"], "nulls_not_distinct": true }
					}
				}
			}
		}
	],
	"wipe": ["task_lists", "tasks", "acl.task_lists"],
	"acl_tables": {
		"task_lists": "acl.task_lists"
	}
}
